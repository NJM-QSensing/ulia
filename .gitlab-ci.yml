stages:
  - test
  - build
  - deploy

################################################################################
# tests

base_test:
  stage: test
  image: python:3.8
  script:
    - pip3 install numpy scipy
    - pip3 install pytest
    - pytest

################################################################################
# Build

bdist:
  stage: build
  only:
    - master
  when: manual
  image: python:3.8
  script:
    - ci/build_wheel.sh
  artifacts:
    expire_in: 1 week
    paths:
      - "dist/*"

################################################################################
# Deploy

.pypi:base: &pypi_template
  stage: deploy
  only:
    - master
  when: manual
  image: python:3.8
  script:
    - deploy.sh

pypi_test:
  <<: *pypi_template
  environment:
    name: PyPI Test
  variables:
    TWINE_REPOSITORY_URL: https://test.pypi.org/legacy/

pypi:
  <<: *pypi_template
  environment:
    name: PyPI
